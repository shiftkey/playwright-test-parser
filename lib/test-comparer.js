const { slowTestsComparer } = require('./comparer')
const { flatMapTests } = require('./parsing')

/** @typedef {"passed" | "failed"} Status */
/** @typedef {{ status: Status, duration: number }} Result */
/** @typedef {{ projectName: string, results: Array<Result> }} Test */
/** @typedef {{ title: string, tests: Array<Test>, line: number }} Spec */
/** @typedef {{ specs: Array<Spec>, line: number, title: string, file: string }} Suite */
/** @typedef {Suite & { suites?: Array<Suite> }} SuiteWithChildSuites */
/** @typedef {{ suites : Array<SuiteWithChildSuites> }} JsonFileContents */

/**
 * Parse the test files and return the slowest tests found
 *
 * @param {JsonFileContents} testOutput JSON from file contents generated by playwright
 * @param {number} count
 *
 * @returns array of files matching
 */
function slowestTests(testOutput, count) {
  const allTests = testOutput.suites.flatMap((s) => flatMapTests(s.file, '', s))

  const testsByDuration = allTests.sort(slowTestsComparer)

  return testsByDuration.slice(0, count)
}

module.exports = {
  slowestTests,
}
